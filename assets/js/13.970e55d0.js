(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{181:function(s,t,a){s.exports=a.p+"assets/img/WechatIMG1345.d16074fd.png"},233:function(s,t,a){"use strict";a.r(t);var n=[function(){var s=this.$createElement,t=this._self._c||s;return t("h1",{attrs:{id:"mha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mha","aria-hidden":"true"}},[this._v("#")]),this._v(" MHA")])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"功能："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#功能：","aria-hidden":"true"}},[this._v("#")]),this._v(" 功能：")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[a("h4",[s._v("监控主数据库服务器，是否可用")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("解决主服务器的单点问题")])]),s._v(" "),a("li",[a("p",[s._v("只可监控主数据库")])])])]),s._v(" "),a("li",[a("h4",[s._v("当主DB不可用时，从多个从服务器中选举新的主数据库服务器作为集群主使用。")])]),s._v(" "),a("li",[a("h4",[s._v("提供了主从切换和故障转移")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("切换过程中，会尝试从宕机的主服务器上保存二进制日志，并最大程度保证事务的不丢失，并不总是可行。比如：硬件和网络故障，无法进行SSH进行访问，就无法进行保存二进制文件，只能进行故障转移。此时也会丢失一部分是数据。")])]),s._v(" "),a("li",[a("p",[s._v("MHA可以与半同步复制结构")])]),s._v(" "),a("li",[a("p",[s._v("逻辑操作：MHA监控发现主服务器不可访问时，会自动进行故障转移和切换操作。")])])])]),s._v(" "),a("li",[a("h4",[s._v("主从切换过程")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("MHA监控发现主服务器不可访问时，会自动进行故障转移和切换操作")])]),s._v(" "),a("li",[a("p",[s._v("会尝试从宕机的主服务器上保存二进制日志，并最大程度保证事务的不丢失")])]),s._v(" "),a("li",[a("p",[s._v("从多个备选从服务器中选举新的备选主服务器，也就是说在丛服务器中，选择一个和原主最接近的从服务器，作为新的主服务。")]),s._v(" "),a("ul",[a("li",[s._v("通过配置，可以人为的设置一些服务器不参与选举。")])])]),s._v(" "),a("li",[a("p",[s._v("在备选主服务器和其他从服务器之间同步差异二进制数据")])]),s._v(" "),a("li",[a("p",[s._v("应用从原主DB服务器上保存二进制日志")])]),s._v(" "),a("li",[a("p",[s._v("提升备选主DB服务器为新的主DB服务器，虚拟IP切换")])]),s._v(" "),a("li",[a("p",[s._v("迁移集群中的其他DB作为新的主DB的从服务器")])])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"优缺点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优缺点","aria-hidden":"true"}},[this._v("#")]),this._v(" 优缺点")])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"优"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优","aria-hidden":"true"}},[this._v("#")]),this._v(" 优")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[t("h4",[this._v("使用Perl脚本语言开发及完全开源")])]),this._v(" "),t("li",[t("h4",[this._v("支持GTID、日志点复制")])]),this._v(" "),t("li",[t("h4",[this._v("故障转移时，不易产生数据丢失")])]),this._v(" "),t("li",[t("h4",[this._v("同一个监控节点可以监控多个集群")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"缺点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#缺点","aria-hidden":"true"}},[this._v("#")]),this._v(" 缺点")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[a("h4",[s._v("需要编写脚本或利用第三方工具来实现VIP的配置 ")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("默认情况下，并不会给主的服务器，增加虚拟VIP")])]),s._v(" "),a("li",[a("p",[s._v("自己开发脚本，使用mha接口，调用脚本。")])])])]),s._v(" "),a("li",[a("h4",[s._v("mha启动后只会对主数据库库进行监控")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("主从延迟增大等，无法监控")])]),s._v(" "),a("li",[a("p",[s._v("复制链路中断，无法监控")])]),s._v(" "),a("li",[a("p",[s._v("也无法像3M那样，主从链路出现问题时，通过切换出现故障的从服务器读VIP的方式，来排除出问题的从服务器。")])])])]),s._v(" "),a("li",[a("h4",[s._v("需要基于SSH免认证登陆，存在一定的安全隐患")])]),s._v(" "),a("li",[a("h4",[s._v("没有提供从服务器的读负载均衡功能")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"工作模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#工作模式","aria-hidden":"true"}},[this._v("#")]),this._v(" 工作模式")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[t("h4",[this._v("拓扑图")]),this._v(" "),t("img",{staticStyle:{width:"500px"},attrs:{src:a(181)}})])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"部署资源和准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署资源和准备","aria-hidden":"true"}},[this._v("#")]),this._v(" 部署资源和准备")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("table",[a("thead",[a("tr",[a("th",[s._v("资源名称")]),s._v(" "),a("th",{staticStyle:{"text-align":"center"}},[s._v("数量")]),s._v(" "),a("th",{staticStyle:{"text-align":"center"}},[s._v("说明")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("主DB服务器")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("2")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("用于主备模式的主主复制配置")])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"开始部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开始部署","aria-hidden":"true"}},[this._v("#")]),this._v(" 开始部署")])},function(){var s=this.$createElement,t=this._self._c||s;return t("li",[t("h4",[this._v(" 配置集群内所有主机SSH免认证登陆 ")]),this._v(" "),t("ul",[t("li",[t("p",[this._v("故障转移过程中，保存原主服务器二进制日志")])]),this._v(" "),t("li",[t("p",[this._v("配置虚拟IP地址等")])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("li",[t("h4",[this._v("安装软件 ")]),this._v(" "),t("ul",[t("li",[this._v("MHA-node ( 集群所有机器上都要安装)")]),this._v(" "),t("li",[this._v("MHA-manager (集群监控服务器上安装)")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("li",[t("h4",[this._v("配置MHA管理节点")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"配置ssh"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置ssh","aria-hidden":"true"}},[this._v("#")]),this._v(" 配置SSH")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[a("p",[s._v("生成密钥")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ssh-keygen\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("拷贝密钥到其他机器")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ssh-copy-id -i /root/.ssh/id_rsa root@172.17.183.XXX\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"安装软件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装软件","aria-hidden":"true"}},[this._v("#")]),this._v(" 安装软件")])},function(){var s=this.$createElement,t=this._self._c||s;return t("li",[t("p",[this._v("安装Perl软件支持包")]),this._v(" "),t("ul",[t("li",[this._v("所有节点都需要安装")])]),this._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("yum -y install perl-DBD-MySQL ncftp perl-DBI.x86\n")])]),this._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[this._v("1")]),t("br")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("li",[t("p",[this._v("安装节点包")]),this._v(" "),t("ul",[t("li",[this._v("所有节点都需要安装")])]),this._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("rpm -ivh mha4mysql-node-0.57-0.el7.noarch.rpm\n")])]),this._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[this._v("1")]),t("br")])])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("li",[a("p",[s._v("安装管理包")]),s._v(" "),a("ul",[a("li",[s._v("manager 负责集群，主从等故障转移，以及VIP节点切换工作，需要的依赖包比较多")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum -y install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker perl-CPAN\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rpm -ivh mha4mysql-manager-0.57-0.el7.noarch.rpm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"创建数据库账号"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建数据库账号","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建数据库账号")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[t("p",[this._v("创建监控账号， 最好在主数据库创建，这样会同步到其他服务器")]),this._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("grant all privileges on *.* to 'mha'@'172.17.183.%' identified by 'demo@123456';\n")])]),this._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[this._v("1")]),t("br")])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"创建相关目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建相关目录","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建相关目录")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[a("p",[s._v("创建mha配置错误")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mkdir -p /ect/mha\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("设置保存从原主服务器下载到二进制文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mkdir -p /home/mysql_mha\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"配置参数-mha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置参数-mha","aria-hidden":"true"}},[this._v("#")]),this._v(" 配置参数 mha")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[a("p",[s._v("设置参数 vim /etc/mha/mha.cnf")]),s._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//数据库监控账号和密码")]),s._v("\nuser"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mha \npassword"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("demo@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//工作目录")]),s._v("\nmanager_workdir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql_mha\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//监控log地址")]),s._v("\nmanager_log"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql_mha"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("manager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//原程工作目录")]),s._v("\nremote_workdir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql_mha\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//ssh账号，免认证")]),s._v("\nssh_user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//mysql复制用户的账号和密码")]),s._v("\nrepl_user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("slave\nrepl_password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("demo@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//mangager进程去检查主数据库是否可以连通的参数,用ping命令实现")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//这里的值是时间间隔，单位是秒。")]),s._v("\nping_interval"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//mysql master binlog 的地址,最好所有服务的binlog地址一样")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//这样，进行主从切换时，就不需要修改配置文件了")]),s._v("\nmaster_binlog_dir "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//指定一个脚本，在主从切换后，可以把主的虚IP绑定在新的主上。（虚拟漂移）")]),s._v("\nmaster_ip_failover_script "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("master_ip_failover\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//可以通过网络的方式，去检查主服务是否正常，避免网络抖动造成的不必要的切换")]),s._v("\nsecondary_check_script"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("masterha_secondary_check "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".183")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".121")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".183")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".122")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".183")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".123")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//candidate_master的意思，参加master选举")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nhostname"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".183")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".121")]),s._v("\ncandidate_master"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//candidate_master的意思，参加master选举")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nhostname"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".183")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".122")]),s._v("\ncandidate_master"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//no_master的意思，不参加master选举")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nhostname"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".183")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".123")]),s._v("\nno_master"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("脚本文件 "),a("code",[s._v("vim /usr/local/bin/master_ip_failover")])]),s._v(" "),a("div",{staticClass:"language-perl line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-perl"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/usr/bin/env perl")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" strict"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" warnings FATAL "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'all'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" Getopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("Long"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_ssh_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_ssh_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_password")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$vip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'172.17.183.90/24'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$key")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_start_vip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo /sbin/ifconfig eth0:$key $vip"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_stop_vip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo /sbin/ifconfig eth0:$key down"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_Bcast_arp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo /sbin/arping -I bond0 -c 3 -A #vip#"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nGetOptions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'command=s'")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ssh_user=s'")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'orig_master_host=s'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'orig_master_ip=s'")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'orig_master_port=i'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'orig_master_ssh_port=i'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$orig_master_ssh_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new_master_host=s'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new_master_ip=s'")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new_master_port=i'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new_master_ssh_port'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_ssh_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new_master_user'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new_master_password'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$new_master_password")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nexit "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("&main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sub")]),s._v(" main")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" defined "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh_user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\n\\nIN SCRIPT TEST====$ssh_user|$ssh_stop_vip==$ssh_user|$ssh_start_vip===\\n\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("eq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stop"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("eq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stopssh"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("eval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Disabling the VIP on old master: $orig_master_host \\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("&stop_vip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$@")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            warn "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Got Error: $@\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            exit "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        exit "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elsif")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("eq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"start"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("my")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("eval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enabling the VIP - $vip on the new master - $new_master_host \\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("&start_vip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("&start_arp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$@")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            warn "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$@")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            exit "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        exit "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exit_code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elsif")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("eq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Checking the Status of the script.. OK \\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        exit "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("&usage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        exit "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sub")]),s._v(" start_vip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`ssh $ssh_user\\@$new_master_host \\" $ssh_start_vip \\"`')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sub")]),s._v(" stop_vip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`ssh $ssh_user\\@$orig_master_host \\" $ssh_stop_vip \\"`')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sub")]),s._v(" start_arp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('`ssh $ssh_user\\@$new_master_host \\" $ssh_Bcast_arp \\"`')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sub")]),s._v(" usage")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Usage: master_ip_failover --command=start|stop|stopssh|status --ssh_user=user --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br")])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"配置主服务的虚拟ip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置主服务的虚拟ip","aria-hidden":"true"}},[this._v("#")]),this._v(" 配置主服务的虚拟IP")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[t("p",[this._v("mha并不会主动配置默认主服务的虚拟IP，需要人工配置，之后发生故障时，mha会自动迁移虚拟ip")]),this._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("ifconfig eth0: 172.17.183.150/24 \n")])]),this._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[this._v("1")]),t("br")])])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"服务命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务命令","aria-hidden":"true"}},[this._v("#")]),this._v(" 服务命令")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[a("p",[s._v("免认证的功能检测")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("masterha_check_ssh --conf /etc/mha/mha.cnf \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("检测集群中的复制链路")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("masterha_check_repl --conf /etc/mha/mha.cnf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("启动 mha manager")]),s._v(" "),a("ul",[a("li",[s._v("后台运行")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("nohup masterha_manager --conf=/etc/mha/mha.cnf &\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])])}],e=a(0),r=Object(e.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[s._m(0),s._v(" "),s._m(1),s._v(" "),s._m(2),s._v(" "),s._m(3),s._v(" "),s._m(4),s._v(" "),s._m(5),s._v(" "),s._m(6),s._v(" "),s._m(7),s._v(" "),s._m(8),s._v(" "),s._m(9),s._v(" "),s._m(10),s._v(" "),s._m(11),s._v(" "),s._m(12),s._v(" "),a("ul",[a("li",[a("p",[s._v("先配置好基于GTID等主从复制")]),s._v(" "),a("p",[a("router-link",{attrs:{to:"/mysql_master_slave/gtid.html"}},[s._v("基于GTID复制")])],1)]),s._v(" "),s._m(13),s._v(" "),s._m(14),s._v(" "),s._m(15)]),s._v(" "),s._m(16),s._v(" "),a("p",[s._v("免认证登陆，故障迁移等。")]),s._v(" "),s._m(17),s._v(" "),s._m(18),s._v(" "),a("ul",[a("li",[a("p",[s._v("下载地址")]),s._v(" "),a("ul",[a("li",[a("p",[a("a",{attrs:{href:"https://github.com/yoshinorim/mha4mysql-manager/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("mha-manager"),a("OutboundLink")],1)])]),s._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://github.com/yoshinorim/mha4mysql-node/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("mha-node"),a("OutboundLink")],1)])])])]),s._v(" "),s._m(19),s._v(" "),s._m(20),s._v(" "),s._m(21)]),s._v(" "),s._m(22),s._v(" "),s._m(23),s._v(" "),s._m(24),s._v(" "),s._m(25),s._v(" "),s._m(26),s._v(" "),s._m(27),s._v(" "),s._m(28),s._v(" "),s._m(29),s._v(" "),s._m(30),s._v(" "),s._m(31)])},n,!1,null,null,null);r.options.__file="mha.md";t.default=r.exports}}]);